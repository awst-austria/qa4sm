# Generated by Django 2.1 on 2019-04-02 14:45

from django.db import migrations, models
import django.db.models.deletion

# (SCALE_DATA, 'data to reference'),
# (SCALE_REF, 'reference to data')
SCALE_DATA = 'data'
SCALE_REF = 'ref'

# see: https://docs.djangoproject.com/en/2.1/topics/migrations/#data-migrations
def update_validation_runs(apps, schema_editor):
    # We can't import the ValidationRun model directly as it may be a newer
    # version than this migration expects. We use the historical version.
    ValidationRun = apps.get_model('validator', 'ValidationRun')
    DatasetConfiguration = apps.get_model('validator', 'DatasetConfiguration')
    for run in ValidationRun.objects.all():

        dataset_c = DatasetConfiguration()
        dataset_c.validation = run
        dataset_c.dataset = run.data_dataset
        dataset_c.version = run.data_version
        dataset_c.variable = run.data_variable
        dataset_c.save()

        dataset_c.filters.set(run.data_filters.all())
        dataset_c.save()

        reference_c = DatasetConfiguration()
        reference_c.validation = run
        reference_c.dataset = run.ref_dataset
        reference_c.version = run.ref_version
        if run.ref_variable:
            reference_c.variable = run.ref_variable
        else:
            print("\nWARNING Validation run {} has no reference variable. Deleting.".format(run))
            run.delete()
            dataset_c.delete()
            continue

        reference_c.save()

        reference_c.filters.set(run.ref_filters.all())
        reference_c.save()

        run.reference_configuration = reference_c

        if run.scaling_ref == SCALE_DATA:
            run.scaling_ref = reference_c
        else:
            run.scaling_ref = dataset_c

        run.save()

class Migration(migrations.Migration):

    dependencies = [
        ('validator', '0004_prep_mulitple_datasets_20190402_1649'),
    ]

    operations = [
        migrations.RunPython(update_validation_runs),
    ]
