{% extends 'common/base.html' %}
{% load widget_tweaks %}
{% load static %}

{% block content %}
    <form action="{% url 'validation' %}" method="post" id="validation_form" data-options-url="{% url 'ajax_get_dataset_options' %}" version-options-url="{% url 'ajax_get_version_id' %}" version-info-url="{% url 'ajax_get_version_info' %}">
        {% csrf_token %}

        {% with WIDGET_ERROR_CLASS='is-invalid' %}

            {% if maintenance_mode is True  %}
                <div class="container text-center mb-5 mt-4" style="max-width: 40rem;">
                    <h1 class="jumbotron-heading">Maintenance...</h1>
                    <p class="lead text-muted">Sorry! Currently, you can't start new validations because we're doing maintenance on the service. Please come back later.</p>
                </div>

            {% else %}
                <div class="container center-text">

                    <div class="card-deck">

                        <div id="data_accordion" style="flex-basis: 50%;">
                            <div class="card mb-4 shadow-sm">
                                <div class="card-header" id="data_header">
                                    <h4 class="my-0 font-weight-normal">Data</h4>

                                    <div class="card-menu">
                                        <span class="input-group-text fas fa-question-circle"
                                            title="The soil moisture dataset which is to be validated, i.e. compared to the 'Reference' data."></span>

                                        <a class="input-group-text" data-toggle="collapse" href="#data_collapse" role="button" aria-expanded="true" aria-controls="data_collapse">
                                            <span class="fa fa-plus-circle" title="Expand"></span>
                                            <span class="fa fa-minus-circle" title="Collapse"></span>
                                        </a>
                                    </div>
                                </div>

                                <div id="data_collapse" class="collapse show" aria-labelledby="data_header" data-parent="#data_accordion">
                                    {% for error in dc_formset.non_form_errors %}
                                        <div class="custom-invalid-feedback">
                                            {{ error }}
                                        </div>
                                    {% endfor %}

                                    <nav>
                                        <div class="nav nav-tabs" id="nav-tab" role="tablist">
                                            {% for dc_form in dc_formset %}
                                                <a class="dc_form_link nav-item nav-link {% if forloop.last %}active{% endif %}" id="id_{{ dc_form.prefix }}-tab" data-toggle="tab" href="#id_{{ dc_form.prefix }}"  aria-controls="id_{{ dc_form.prefix }}" aria-selected="{% if forloop.last %}true{%else%}false{% endif %}" onclick="shiftTheButton(event, '#remove_dc_form')">Dataset</a>
                                            {% endfor %}
                                                <a id="add_dc_form" value='{{ dc.formset|length }}' class="tab-plus btn btn-primary {%if dc_formset|length == dc_formset.max_num%}hide_element{%endif%}" href="javascript:void(0)"><span class="fas fa-plus" title="Add another dataset"></span></a>
                                                <a id="remove_dc_form" class="tab-minus {%if dc_formset|length == dc_formset.min_num%}hide_element{%endif%}"  href="javascript:void(0)" title="Remove active dataset">&times;</a>
                                        </div>
                                    </nav>

                                    {{ dc_formset.management_form }}

                                    <div id="dc_form_container" class="card-body tab-content">

                                        {% for dc_form in dc_formset.forms %}
                                            <div class="dc_form tab-pane fade {% if forloop.last %}show active{% endif %}" id="id_{{ dc_form.prefix }}" role="tabpanel" aria-labelledby="id_{{ dc_form.prefix }}-tab">
                                                <div class="mb-3">
                                                    <div class="input-group">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text addon-w" id="data-addon1">Dataset</span>
                                                        </div>
                                                        {% render_field dc_form.dataset class="custom-select" %}
                                                    </div>
                                                    {% for error in dc_form.dataset.errors %}
                                                        <div class="custom-invalid-feedback">
                                                            {{ error }}
                                                        </div>
                                                    {% endfor %}
                                                </div>

                                                <div class="mb-3">
                                                    <div class="input-group">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text addon-w" id="data-addon2">Version</span>
                                                        </div>
                                                        {% render_field dc_form.version class="custom-select" %}
                                                    </div>
                                                    {% for error in dc_form.version.errors %}
                                                        <div class="custom-invalid-feedback">
                                                            {{ error }}
                                                        </div>
                                                    {% endfor %}
                                                </div>

                                                <div class="mb-3">
                                                    <div class="input-group">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text addon-w" id="data-addon3">Variable</span>
                                                        </div>
                                                        {% render_field dc_form.variable class="custom-select" %}
                                                    </div>
                                                    {% for error in dc_form.variable.errors %}
                                                        <div class="custom-invalid-feedback">
                                                            {{ error }}
                                                        </div>
                                                    {% endfor %}
                                                </div>

                                                <hr/>

                                                <div class="custom-control custom-switch">
                                                    <input class="custom-control-input" id="{{dc_form.filter_dataset.auto_id}}" name="{{dc_form.prefix}}-{{dc_form.filter_dataset.name}}"
                                                        {{ dc_form.filter_dataset.initial|yesno:'checked,,' }} type="checkbox" onclick="toggleFiltering(this)">
                                                    <label class="custom-control-label" for="{{dc_form.filter_dataset.auto_id}}">{{dc_form.filter_dataset.label}}</label>

                                                    <span class="input-group-text fas fa-question-circle help-icon"
                                                        title="Only data which meet the specified criteria will be used in the validation. Several filters can be simultaneously selected for one dataset. You can also omit filtering completely."></span>
                                                </div>

                                                <div id="id_{{dc_form.prefix}}-filters" class="indented tabSpecific">
                                                    {{ dc_form.filters }}
                                                </div>
                                                <div id="id_{{dc_form.prefix}}-parametrised_filters" class="indented tabSpecific">
                                                    {{ dc_form.parametrised_filters }}
                                                </div>
                                            </div>
                                        {% endfor %}

                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="ref_accordion" style="flex-basis: 50%;">
                            <div class="card mb-4 shadow-sm">
                                <div class="card-header" id="ref_header">
                                    <h4 class="my-0 font-weight-normal">Reference</h4>

                                    <div class="card-menu">
                                        <span class="input-group-text fas fa-question-circle help-icon"
                                            title="The data which is to be used as a reference in the validation. The 'Data' will be compared against this reference."></span>
                                        <a class="input-group-text" data-toggle="collapse" href="#ref_collapse" role="button" aria-expanded="true" aria-controls="ref_collapse">
                                            <span class="fa fa-plus-circle" title="Expand"></span>
                                            <span class="fa fa-minus-circle" title="Collapse"></span>
                                        </a>
                                    </div>
                                </div>

                                <div id="ref_collapse" class="collapse show" aria-labelledby="ref_header" data-parent="#ref_accordion">
                                    <div style="min-height: 2.1rem;"></div>

                                    <div class="card-body">
                                        <div class="mb-3">
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text addon-w" id="ref-addon1">Dataset</span>
                                                </div>
                                                {% render_field ref_dc_form.dataset class="custom-select" %}
                                            </div>
                                            {% for error in ref_dc_form.dataset.errors %}
                                                <div class="custom-invalid-feedback">
                                                    {{ error }}
                                                </div>
                                            {% endfor %}
                                        </div>

                                        <div class="mb-3">
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text addon-w" id="ref-addon2">Version</span>
                                                </div>
                                                <input type="hidden" id="id_target_hidden_input_version" value="" name="target_hidden_input_version">
                                                {% render_field ref_dc_form.version class="custom-select" %}
                                            </div>
                                            {% for error in ref_dc_form.version.errors %}
                                                <div class="custom-invalid-feedback">
                                                    {{ error }}
                                                </div>
                                            {% endfor %}
                                        </div>

                                        <div class="mb-3">
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text addon-w" id="ref-addon3">Variable</span>
                                                </div>
                                                {% render_field ref_dc_form.variable class="custom-select" %}
                                            </div>
                                            {% for error in ref_dc_form.variable.errors %}
                                                <div class="custom-invalid-feedback">
                                                    {{ error }}
                                                </div>
                                            {% endfor %}
                                        </div>

                                        <hr/>

                                        <div class="custom-control custom-switch">
                                            <input class="custom-control-input" id="{{ref_dc_form.filter_dataset.auto_id}}" name="{{ref_dc_form.prefix}}-{{ref_dc_form.filter_dataset.name}}"
                                                {{ ref_dc_form.filter_dataset.initial|yesno:'checked,,' }} type="checkbox" onclick="toggleFiltering(this, 'ref-filters')">
                                            <label class="custom-control-label" for="{{ref_dc_form.filter_dataset.auto_id}}">{{ref_dc_form.filter_dataset.label}}</label>
                                            <span class="input-group-text fas fa-question-circle help-icon"
                                                title="Only reference data which meet the specified criteria will be used in the validation. Several filters can be simultaneously selected for one dataset. You can also omit filtering completely."></span>
                                        </div>

                                        <div id="id_{{ref_dc_form.prefix}}-filters" class="indented">
                                            {{ ref_dc_form.filters }}
                                        </div>
                                        <div id="id_{{ref_dc_form.prefix}}-parametrised_filters" class="indented">
                                            {{ ref_dc_form.parametrised_filters }}
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-deck">
                        <div id="spatial_accordion" style="width:100%">
                            <div class="card mb-4 shadow-sm">
                                <div class="card-header" id="spatial_header">
                                    <h4 class="my-0 font-weight-normal">Spatial Subsetting</h4>
                                    <div class="card-menu">
                                        <span class="input-group-text fas fa-question-circle help-icon"
                                            title="Restrict the input and reference data to a lat/lon bounding box (specified with lower left and upper right corner coordinates). You can also select the bounding box on a map by clicking on the globe button."></span>
                                        <a class="input-group-text" data-toggle="collapse" href="#spatial_collapse" role="button" aria-expanded="true" aria-controls="spatial_collapse">
                                            <span class="fa fa-plus-circle" title="Expand"></span>
                                            <span class="fa fa-minus-circle" title="Collapse"></span>
                                        </a>
                                    </div>
                                </div>
                                <div id="spatial_collapse" class="collapse show" aria-labelledby="spatial_header" data-parent="#spatial_accordion">
                                    <div class="card-body">
                                        <div class="container">
                                            <div class="row justify-content-around">

                                                <div class="col-sm px-0">
                                                    <div class="input-group">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text addon-w" id="scaling_addon_ll" title="Lower left bounding box corner">Lower left</span>
                                                        </div>
                                                        {% render_field val_form.min_lat placeholder="Lat" title="Lat" class="form-control" %}
                                                        {% render_field val_form.min_lon placeholder="Lon" title="Lon" class="form-control" %}
                                                    </div>
                                                    {% for error in val_form.min_lat.errors %}
                                                        <div class="custom-invalid-feedback">
                                                            {{ error }}
                                                        </div>
                                                    {% endfor %}
                                                    {% for error in val_form.min_lon.errors %}
                                                        <div class="custom-invalid-feedback">
                                                            {{ error }}
                                                        </div>
                                                    {% endfor %}
                                                </div>

                                                <div class="px-2 py-2 py-sm-0">
                                                    <button type="button" title="Select on map" class="btn btn-primary" data-toggle="modal" data-target="#mapDialog">
                                                        <span class="fas fa-globe" ></span>
                                                    </button>
                                                    <button type="button" title="Clear coordinates" class="btn btn-primary" onclick="clearCoordinates()">
                                                        <span class="fas fa-trash-alt" ></span>
                                                    </button>
                                                </div>

                                                <div class="col-sm px-0">
                                                    <div class="input-group">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text addon-w" id="scaling_addon_ur" title="Upper right bounding box corner">Upper right</span>
                                                        </div>
                                                        {% render_field val_form.max_lat placeholder="Lat" title="Lat" class="form-control" %}
                                                        {% render_field val_form.max_lon placeholder="Lon" title="Lon" class="form-control" %}
                                                    </div>
                                                    {% for error in val_form.max_lat.errors %}
                                                        <div class="custom-invalid-feedback">
                                                            {{ error }}
                                                        </div>
                                                    {% endfor %}
                                                    {% for error in val_form.max_lon.errors %}
                                                        <div class="custom-invalid-feedback">
                                                            {{ error }}
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-deck">
                        <div id="temporal_accordion" style="width:100%">
                            <div class="card mb-4 shadow-sm">
                                <div class="card-header" id="temporal_header">
                                    <h4 class="my-0 font-weight-normal">Validation Period</h4>
                                    <div class="card-menu">
                                        <span class="input-group-text fas fa-question-circle help-icon"
                                            title="Restricts the input and reference data to the time period given. Days 'from' and 'to' are fully included in the interval."></span>
                                        <a class="input-group-text" data-toggle="collapse" href="#temporal_collapse" role="button" aria-expanded="true" aria-controls="temporal_collapse">
                                            <span class="fa fa-plus-circle" title="Expand"></span>
                                            <span class="fa fa-minus-circle" title="Collapse"></span>
                                        </a>
                                    </div>
                                </div>
                                <div id="temporal_collapse" class="collapse show" aria-labelledby="temporal_header" data-parent="#temporal_accordion">
                                    <div class="card-body">

                                        <div class="container">
                                            <div class="row">

                                                <div class="col-sm px-0 pr-sm-2 pb-1 py-sm-0">
                                                    <div class="input-group">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text addon-w" id="scaling_addon1">From</span>
                                                        </div>
                                                        {% render_field val_form.interval_from class="form-control" %}
                                                    </div>
                                                    {% for error in val_form.interval_from.errors %}
                                                        <div class="custom-invalid-feedback">
                                                            {{ error }}
                                                        </div>
                                                    {% endfor %}
                                                </div>

                                                <div class="col-sm px-0 pl-sm-2 pt-1 py-sm-0">
                                                    <div class="input-group">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text addon-w" id="scaling_addon2">To</span>
                                                        </div>
                                                        {% render_field val_form.interval_to class="form-control" %}
                                                    </div>
                                                    {% for error in val_form.interval_to.errors %}
                                                        <div class="custom-invalid-feedback">
                                                            {{ error }}
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-deck">
                        <div id="metrics_accordion" style="width:100%">
                            <div class="card mb-4 shadow-sm">
                                <div class="card-header" id="metrics_header">
                                    <h4 class="my-0 font-weight-normal">Metrics</h4>
                                    <div class="card-menu">
                                        <span class="input-group-text fas fa-question-circle help-icon"
                                            title="Specify metrics to calculate. Basic metrics between data set pairs are always calculated."></span>
                                        <a class="input-group-text" data-toggle="collapse" href="#metrics_collapse" role="button" aria-expanded="true" aria-controls="metrics_collapse">
                                            <span class="fa fa-plus-circle" title="Expand"></span>
                                            <span class="fa fa-minus-circle" title="Collapse"></span>
                                        </a>
                                    </div>
                                </div>
                                <div id="metrics_collapse" class="collapse show" aria-labelledby="metrics_header" data-parent="#metrics_accordion">
                                    <div class="card-body">

                                        <div class="container">
                                            <div class="row">
                                                 <div class="custom-control custom-switch">
                                                    <input id="tcol" class="custom-control-input" name="tcol" type="checkbox" disabled="true">
                                                    <label class="custom-control-label" for="tcol">Include Triple Collocation Metrics &nbsp;</label>
                                                 </div>

                                                <span class="input-group-text fas fa-question-circle help-icon"
                                                    title="Triple collocation analysis is only available if 3 or more data sets (including the reference) are selected.">
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-deck">
                        <div id="anom_accordion" style="width:100%">
                            <div class="card mb-4 shadow-sm">
                                <div class="card-header" id="anom_header">
                                    <h4 class="my-0 font-weight-normal">Anomalies</h4>
                                    <div class="card-menu">
                                        <span class="input-group-text fas fa-question-circle help-icon"
                                            title="Optionally calculates metrics from anomalies instead of absolute values. First, a climatology is computed using the chosen method and time period (only whole years are used), then the anomalies are calculated based on this. &quot;35 day moving average&quot; means that the climatology is calculated as a moving average of the data; &quot;climatology&quot; means that the average for each day of the year is calculated."></span>
                                        <a class="input-group-text" data-toggle="collapse" href="#anom_collapse" role="button" aria-expanded="false" aria-controls="anom_collapse">
                                            <span class="fa fa-plus-circle" title="Expand"></span>
                                            <span class="fa fa-minus-circle" title="Collapse"></span>
                                        </a>
                                    </div>
                                </div>

                                <div id="anom_collapse" class="collapse" aria-labelledby="anom_header" data-parent="#anom_accordion">
                                    <div class="card-body">

                                        <div class="container">
                                            <div class="column">

                                                <div class="row">

                                                    <div class="col-sm px-0">
                                                        <div class="input-group" title="Anomalies calculation method: no anomalies, anomalies against 35 day moving average or anomalies against a climatology calculated from the given timespan.">
                                                            <div class="input-group-prepend">
                                                                <span class="input-group-text addon-w" id="scaling_addon2">Method</span>
                                                            </div>
                                                            {% render_field val_form.anomalies class="custom-select" %}
                                                        </div>
                                                        {% for error in val_form.anomalies.errors %}
                                                            <div class="custom-invalid-feedback">
                                                                {{ error }}
                                                            </div>
                                                        {% endfor %}
                                                    </div>

                                                    <div class="col-sm anomalies-period px-0 px-sm-3 py-2 py-sm-0">
                                                        <div class="input-group" title="Start of period to calculate climatology from.">
                                                            <div class="input-group-prepend">
                                                                <span class="input-group-text addon-w" id="scaling_addon2">From</span>
                                                            </div>
                                                            {% render_field val_form.anomalies_from class="custom-select" %}
                                                        </div>
                                                        {% for error in val_form.anomalies_from.errors %}
                                                            <div class="custom-invalid-feedback">
                                                                {{ error }}
                                                            </div>
                                                        {% endfor %}
                                                    </div>

                                                    <div class="col-sm anomalies-period px-0">
                                                        <div class="input-group" title="End of period to calculate climatology from.">
                                                            <div class="input-group-prepend">
                                                                <span class="input-group-text addon-w" id="scaling_addon2">To</span>
                                                            </div>
                                                            {% render_field val_form.anomalies_to class="custom-select" %}
                                                        </div>
                                                        {% for error in val_form.anomalies_to.errors %}
                                                            <div class="custom-invalid-feedback">
                                                                {{ error }}
                                                            </div>
                                                        {% endfor %}
                                                    </div>

                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-deck">
                        <div id="scaling_accordion" style="width:100%">
                            <div class="card mb-4 shadow-sm">
                                <div class="card-header" id="scaling_header">
                                    <h4 class="my-0 font-weight-normal">Scaling</h4>
                                    <div class="card-menu">
                                        <span class="input-group-text fas fa-question-circle help-icon"
                                            title="The data values will be scaled to the value range of the selected dataset using the selected method. When validating more than one dataset, values will always be scaled to the reference."></span>
                                        <a class="input-group-text" data-toggle="collapse" href="#scaling_collapse" role="button" aria-expanded="false" aria-controls="scaling_collapse">
                                            <span class="fa fa-plus-circle" title="Expand"></span>
                                            <span class="fa fa-minus-circle" title="Collapse"></span>
                                        </a>
                                    </div>
                                </div>
                                <div id="scaling_collapse" class="collapse" aria-labelledby="scaling_header" data-parent="#scaling_accordion">
                                    <div class="card-body">

                                        <div class="container">
                                            <div class="row">

                                                <div class="col-sm px-0 pl-sm-2 pt-1 py-sm-0">
                                                    <div class="input-group">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text addon-w" id="scaling_addon2">Method</span>
                                                        </div>
                                                        {% render_field val_form.scaling_method class="custom-select" %}
                                                    </div>
                                                    {% for error in val_form.scaling_method.errors %}
                                                        <div class="custom-invalid-feedback">
                                                            {{ error }}
                                                        </div>
                                                    {% endfor %}
                                                </div>

                                                 <div class="col-sm scaling-ref px-0 pr-sm-2 pb-1 py-sm-0">
                                                    <div class="input-group">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text addon-w" id="scaling_addon1">Scale To</span>
                                                        </div>
                                                        {% render_field val_form.scaling_ref class="custom-select" %}
                                                    </div>
                                                    {% for error in val_form.scaling_ref.errors %}
                                                        <div class="custom-invalid-feedback">
                                                            {{ error }}
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text addon-w" id="tag-addon1">Name your validation</span>
                        </div>
                        {% render_field val_form.name_tag class="form-control" %}
                        <div class="input-group-append">
                            <span class="input-group-text fas fa-question-circle" id="tag-addon2" title="You can optionally name the validation to make it easier to identify in your list of validations."></span>
                        </div>
                    </div>
                    {% for error in val_form.name_tag.errors %}
                        <div class="custom-invalid-feedback">
                            {{ error }}
                        </div>
                    {% endfor %}


                    <input id='validate-run' class="btn btn-lg btn-primary mb-3" type="submit" value="&#9658; Validate">
                    <!-- this is a hidden field so it is possible to count how many times the Validate button was clicked -->
                    <input id='click-counter' name='click-counter' type='hidden' value=1>
                    <!-- this is an area triggered as a dialog window for informing user that there is a validation with given settings -->
                    <div id="pub_validate-confirm" class='validate-confirm' title="Would you like to use an existing validation?" data-url="{% if val_id %}{% url 'result' val_id %}{% endif%}">
                      There exists a published validation with exactly the same settings, run on {{val_date}}. <br>
                      You can run your own validation and wait for the results or you can use the existing one.<br>
                      You can also close this window and change some settings.<br>
                      What would you like to do?
                    </div>
                    <div id="non_pub_validate-confirm" class='validate-confirm' title="Would you like to use an existing validation?" data-url="{% if val_id %}{% url 'result' val_id %}{% endif%}">
                      {% if belongs_to_user == True %}
                      You have already run a validation with exactly the same settings on {{val_date}}. <br>
                      You can run it again or use the existing one. <br>
                      {% else %}
                      There exists a validation with exactly the same settings, run on {{val_date}}. <br>
                      You can run your own validation and wait for the results or you can use the existing one.<br>
                      {% endif %}
                      You can also close this window and change some settings.<br>
                      What would you like to do?
                    </div>

                </div>
            {% endif %}
        {% endwith %}
    </form>

{% endblock %}

{% block dialogs %}

    <div class="modal" id="mapDialog" role="dialog" aria-labelledby="mapDialogTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">

                <div class="modal-header">
                    <h4 class="my-0 font-weight-normal" id="mapDialogTitle">Select bounding box</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">&times;</button>
                </div>

                <div class="modal-body">
                    <div style="width: 100%; height: 60vh;" id="spatialFilterMap"></div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button id="setCoordinatesButton" type="button" onclick="setCoordinates()" class="btn btn-primary">Use coordinates</button>
                </div>

            </div>
        </div>
    </div>

    {% include "validator/ismn_dialog.html"%}

{% endblock %}

{% block javascript %}
    <link rel="stylesheet" href="/static/leaflet/leaflet.css" />
    <script src="/static/leaflet/leaflet.js"></script>

    <link rel="stylesheet" href="/static/leaflet/leaflet.draw.css" />
    <script src="/static/leaflet/leaflet.draw.js"></script>


    <script type="text/javascript">
        var southWest = L.latLng(-90, -360), northEast = L.latLng(90, 360), bounds = L.latLngBounds(southWest, northEast);
        var map = L.map('spatialFilterMap', { maxBounds: bounds });
        var osmUrl='https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        var osmAttrib='Map data Â© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors';
        var osm = new L.TileLayer(osmUrl, {minZoom: 1, maxZoom: 20, attribution: osmAttrib});
        var drawnItems = new L.FeatureGroup();
        var drawControl = new L.Control.Draw({
            draw: {
                polygon: false,
                polyline: false,
                circle: false,
                circlemarker: false,
                marker: false
            },
            edit: {
                featureGroup: drawnItems
            }
        });
        map.addLayer(drawnItems);
        map.addControl(drawControl);
        map.setView(new L.LatLng(48.2, 16.37), 3.4);
        map.addLayer(osm);

        function setCoordinates(){
            coordinates=drawnItems.getLayers()[0].getLatLngs();

            $('#id_min_lat').val(coordinates[0][0].lat);
            $('#id_min_lon').val(coordinates[0][0].lng);

            $('#id_max_lat').val(coordinates[0][2].lat);
            $('#id_max_lon').val(coordinates[0][2].lng);

            $('#mapDialog').modal('hide');
        }

        function clearCoordinates(){
            $('#id_min_lat').val('');
            $('#id_min_lon').val('');
            $('#id_max_lat').val('');
            $('#id_max_lon').val('');
        }

        function drawBoxFromCoordinates() {
            var min_lat = $('#id_min_lat').val();
            var min_lon = $('#id_min_lon').val();
            var max_lat = $('#id_max_lat').val();
            var max_lon = $('#id_max_lon').val();

            if(min_lat && min_lon && max_lat && max_lon) {
                var bounds = [[min_lat, min_lon], [max_lat, max_lon]];
                var boundingBox = L.rectangle(bounds);
                drawnItems.addLayer(boundingBox);
                map.fitBounds(bounds);
                $('#setCoordinatesButton').prop('disabled', false);
            }
        }

        map.on('draw:created', function (e) {
            var type = e.layerType, layer = e.layer;

            drawnItems.clearLayers();
            drawnItems.addLayer(layer);
            $('#setCoordinatesButton').prop('disabled', false);
        });

        map.on('draw:deleted', function (e) {
            if(drawnItems.getLayers().length == 0) {
                $('#setCoordinatesButton').prop('disabled', true);
            }
        });

        $('#mapDialog').on('show.bs.modal', function(){
            setTimeout(function() { // wait until the dialog is drawn to be able to adjust the map to it
                $('#setCoordinatesButton').prop('disabled', true);
                map.invalidateSize();
                drawnItems.clearLayers();
                drawBoxFromCoordinates()
                }, 10 /* ms */);
        });
    </script>

    <script type="text/javascript">
        function toggleFiltering(checkbox) {
            const filtergroups = ['filters', 'paramfilters'];
            for (const group of filtergroups) {
                var groupId = checkbox.id.replace(/filter_dataset$/, group)
                var filterboxes = $('#' + groupId).find('input:checkbox');
                var newDisabledValue = !checkbox.checked;
                for (var f of filterboxes) {
                    f.disabled=newDisabledValue;
                }
            }
        }
        // on page load, call once:
        {% for dc_form in dc_formset.forms %}
            toggleFiltering($('#{{dc_form.filter_dataset.auto_id}}')[0]);
        {% endfor %}
        toggleFiltering($('#{{ref_dc_form.filter_dataset.auto_id}}')[0]);
    </script>

    <script type="text/javascript">
        function ajax_change_dataset() {
            var url = $("#validation_form").attr("data-options-url");
            var datasetId = $(this).val();
            // var datasetName = $(this).text();
            var widgetId = $(this).attr('id');
            var datasetName = $(`#${widgetId} option[value=${datasetId}]`).text();
            var filterWidgetId = widgetId.replace(/dataset$/, "filters");
            var paramFilterWidgetId = widgetId.replace(/dataset$/, "parametrised_filters");
            $.ajax({
                url: url,
                data: { 'dataset_id': datasetId, 'filter_widget_id': filterWidgetId, 'param_filter_widget_id': paramFilterWidgetId },
                success: function (return_data) {
                    var dataset_widget = "#" + widgetId;
                    var version_widget = dataset_widget.replace(/dataset$/, "version");
                    var variable_widget = dataset_widget.replace(/dataset$/, "variable");
                    var filter_widget = "#" + filterWidgetId;
                    var param_filter_widget = "#" + paramFilterWidgetId;
                    $(version_widget).html(return_data['versions']);
                    $(variable_widget).html(return_data['variables']);
                    $(filter_widget).html(return_data['filters']);
                    $(param_filter_widget).html(return_data['paramfilters']);

                    if(datasetName=='ISMN'){
                        var default_value = $(version_widget).find('option')[0].value;
                        $('#id_target_hidden_input_version').val(default_value);
                    } else{
                        $('#id_target_hidden_input_version').val('');
                    };
                    start_ajax_to_set_valiadtion_period();
                }
            });
        }

        function ajax_take_versions_info(versionIds, funcs_set, args_names) {
          /**
           * Use ajax to read info of given dataset versions;
           * @param  {object} versionIds list of version ids
           * @param  {object} funcs_set  list of name of functions to be called
           * @param  {object} args_names  list of name of arguments returned by ajax, which are passed to given functions
           *
           *
           Example:
           ajax_take_versions_info(versionsIds, [func1, func2, func3], [['intervals_from'], ['intervals_to'], ['intervals_from', 'intervals_to']])
           will call func1 with argument 'intervals_from', func2 with 'intervals_to' and func3 with both of them.
           Functions passed as a list must accept only one object-like argument.
          */
            var url = $("#validation_form").attr("version-info-url");
            $.ajax({
                url: url,
                traditional: true,
                data: {'version_id': versionIds},
                success: function (return_data) {
                  var intervals_from = return_data['intervals_from'];
                  var intervals_to = return_data['intervals_to'];
                  // calling functions given in the functions list
                  ind = 0
                  for (func in funcs_set){
                    // taking values of arguments passed in the parameter args_names and creating a list of their values
                    param_list = get_list_of_params(arguments[0], args_names[ind]);
                    funcs_set[func](param_list);
                    ind++;
                  };
                }
            });
          };

         function get_list_of_params(args, args_names){
            /**
             * Returns a list of values assinged to arguments which names are give in args_names;
             * @param  {object} args list of arguments returned by ajax function: arguments[0]
             * @param  {object} args_names list of names of arguments returned by the ajax function which should be passed further
            */
            param_list = [];
            for (arg_name in args_names){
              var name = args_names[arg_name];
              param_list.push(args[name]);
            };
            return param_list
          };

          function find_current_ids(){
            // Finds all selects which have 'version' in name attribute
            var versions_list = $('select[name*=version]');
            var ids_list = [];
            for(ind=0; ind<versions_list.length; ind++){
              var version_id = parseInt(versions_list[ind].value);
              if (!isNaN(version_id)){
                ids_list.push(version_id)
              };
            };
            return ids_list;
          };
//=========================== Time range related functions =====================================================
          function convert_date_to_string(date){
            // Converts date from Date() constructor to date format YYYY-MM-DD
            var year = date.getFullYear();
            var month = date.getMonth()+1;
            if(month<=9){month = '0'+month};
            var day = date.getDate();
            if(day<=9){day = '0' + day};
            return year + '-' + month + '-' + day;
          };

          function compare_and_set_time_ranges(params){
            /**
             * Compares given time ranges and sets the appropriate ones
                into From and To fields in Validation Period section
             * @param  {object} params list consisting of two lists: intervals_from and intervals_to
            */

            // take appropriate elements from params
            var intervals_from = params[0];
            var intervals_to = params[1];
            dates_from = [];
            dates_to = [];
            // convert string into date
            for (ind=0; ind<intervals_from.length; ind++){
              dates_from.push(new Date(intervals_from[ind]));
              dates_to.push(new Date(intervals_to[ind]));
            };

            // get maximum date from and minimum date to
            var max_date_from = new Date(Math.max.apply(null, dates_from));
            var min_date_to = new Date(Math.min.apply(null, dates_to));

            //reconvert date to string
            var max_date_from_str = convert_date_to_string(max_date_from);
            var min_date_to_str = convert_date_to_string(min_date_to);

            //set appropriate values
            $('#id_interval_from').val(max_date_from_str);
            $('#id_interval_to').val(min_date_to_str);
          }

          function start_ajax_to_set_valiadtion_period(){
            var versionIds = find_current_ids();
            ajax_take_versions_info(versionIds, [compare_and_set_time_ranges], [['intervals_from', 'intervals_to']]);
          }
//================================================================================
      
        function change_tab_name() {
            var datasetName = $(this).find('option:selected').text();
            var tabId = '#' + $(this).attr('id').replace(/dataset$/, 'tab');
            $(tabId).text(datasetName);
        }

        {% for dc_form in dc_formset.forms %}
            $("#{{ dc_form.dataset.auto_id }}").change(ajax_change_dataset).change(change_tab_name).change(); // last change() to call change on pageload
            $("#{{ dc_form.version.auto_id }}").change(start_ajax_to_set_valiadtion_period)
        {% endfor %}

        function get_version_id(){
            var versionId = $(this).val();
            $('#id_target_hidden_input_version').val(versionId)
            // additionally set up default networks
            var hiddenField = $('#id_target_hidden_input')
            if(hiddenId = $('#id_target_hidden_input').val()){
              var hiddenId = $('#id_target_hidden_input').val()
              var default_params = $('#' + hiddenId).attr('data-default_val')
              $('#' + hiddenId).val(default_params)
            }
        }


        $("#{{ ref_dc_form.dataset.auto_id }}").change(ajax_change_dataset).change(); // last change() to call change on pageload
        $('#id_ref-version').change(get_version_id).change(start_ajax_to_set_valiadtion_period)


    </script>

    <script type="text/javascript">
        function onChangeAnomalies() {
            var anomMethod = $(this).val();
            var dateBoxes = $('div.anomalies-period');
            var dateSelectors = dateBoxes.find('select');

            if(anomMethod == 'climatology') {
                dateSelectors.prop('disabled', false);
                dateBoxes.css('visibility', 'visible');
            } else {
                dateSelectors.prop('disabled', true);
                dateBoxes.css('visibility', 'hidden');
            }
        }
        $('#{{ val_form.anomalies.auto_id }}').change(onChangeAnomalies).change(); // last change() to call change on pageload
    </script>

    <script type="text/javascript">
        function onChangeScaleMethod() {
            var scaleMethod = $(this).val();
            var scaleRefBox = $('div.scaling-ref');

            if(scaleMethod == 'none') {
                scaleRefBox.css('visibility', 'hidden');
            } else {
                scaleRefBox.css('visibility', 'visible');
            }
        }
        $('#{{ val_form.scaling_method.auto_id }}').change(onChangeScaleMethod).change(); // last change() to call change on pageload
    </script>

    <script type="text/javascript">
        function cloneTab(tabContentClass, tabLinkClass, formsetPrefix, removeButton ,addButton) {
            var selector = tabContentClass + ':last';
            var link_selector = tabLinkClass + ':last';
            var totalSelector = '#id_' + formsetPrefix + '-TOTAL_FORMS';
            var maxSelector = '#id_' + formsetPrefix + '-MAX_NUM_FORMS';

            var totalNoForms = $(totalSelector).val();
            var oldId = $(selector).attr('id');
            var newId = 'id_' + formsetPrefix + '-' + totalNoForms;
            var newTabId = newId + '-tab';

            // de-select currently selected tab
            $(tabContentClass + '.active').removeClass( "active show");
            $(tabLinkClass + '.active').removeAttr('aria-selected');
            $(tabLinkClass + '.active').removeClass( "active show" );

            // clone tab content
            var newElement = $(selector).clone(true);
            newElement.attr('id', newId);
            newElement.attr('aria-labelledby', newTabId);

            newElement.find(':input').each(function() {
                var id = $(this).attr('id').replace(oldId, newId);
                var name = id.replace(/^id_/, '')
                $(this).attr({'name': name, 'id': id});
            });

            newElement.find('label').each(function() {
                var newFor = $(this).attr('for').replace(oldId, newId);
                $(this).attr('for', newFor);
            });

            newElement.find('.tabSpecific').each(function() {
                var id = $(this).attr('id').replace(oldId, newId);
                $(this).attr('id', id);
            });

            // clone tab link
            var newLink = $(link_selector).clone(false);
            newLink.attr('id', newTabId);
            newLink.attr('href', '#' + newId);
            newLink.attr('aria-controls', newId);

            var newButton = $(removeButton).clone(true)
            removeButton.remove()

            totalNoForms++;
            $(totalSelector).val(totalNoForms);

            // insert new tab and link and select it
            $(selector).after(newElement);
            $(link_selector).after(newLink);
            $(newLink).after(newButton)
            newLink.tab('show')

            // prevent addition of new tabs if max reached
            if ( totalNoForms >= $(maxSelector).val() ) {
                addButton.hide();
            }
           // show remove button
            if ( totalNoForms > 1 ) {
                newButton.show();
            }

            // trigger change event on dataset select so that dependent parameters are set correctly
            $('#' + newId + '-dataset').change();
        }

        function setScalingRef() {
            $("#id_scaling_ref option[value='data']").remove();
            $("#id_scaling_ref").val("ref");
        }

        function addScalingData() {
            $("#id_scaling_ref").append(new Option('Data', 'data'))
        }

        $('#add_dc_form').click(function() {
            cloneTab('.dc_form', '.dc_form_link', 'datasets', $('#remove_dc_form') ,$(this));
            setScalingRef();
            setTcLock();
        });

        function setTcLock() {
            var formsetPrefix = 'datasets';
            var totalSelector = '#id_' + formsetPrefix + '-TOTAL_FORMS';
            var totalNoForms = $(totalSelector).val();
            var n_datasets = parseInt(totalNoForms) + 1
            if ( n_datasets >= 3) {
                $('#tcol').prop('disabled', false);
            } else {
                $('#tcol').prop('checked', false);
                $('#tcol').prop('disabled', true);
            }
        }
    </script>

    <script type="text/javascript">

        function removeTab(tabContentClass, tabLinkClass, formsetPrefix, addButton, removeButton){
        // taking tabs (referred as tabLinkClass in validate.html) and containers (referred as tabContentClass)
        // and choosing the ones to be removed (the active ones)
            var tabs = $(tabLinkClass)
            var containers = $(tabContentClass)

            // removal button is on the right-hand side of the tab to be remove, therefore I'm using prev()
            var tab_to_remove = $(removeButton.prev())
            var container_to_remove = $('#'+tab_to_remove.attr('aria-controls'))

        // taking totalNoForms so that plus sign can be displayed again
            var totalSelector = '#id_' + formsetPrefix + '-TOTAL_FORMS';
            var totalNoForms = $(totalSelector).val();
            var maxSelector = '#id_' + formsetPrefix + '-MAX_NUM_FORMS';

        // this condition enables removing datasets unless there is only one left
        // additionally it's checked if there is the same number of tabs and containers to prevent unexpected errors
            if (tabs.length>1 && containers.length>1 && tabs.length == containers.length){

            // taking next tabs and containers, to change their id's
                var all_next_tabs = tab_to_remove.nextAll(tabLinkClass)
                var all_next_containers = container_to_remove.nextAll(tabContentClass)

            //taking next and previous tabs and containers, to make them active after removal current items
            // since the remove button is placed after each tab then removeButton.next() should be taken
                var next_tab = removeButton.next()
                var prev_tab = tab_to_remove.prev()

                var next_container = container_to_remove.next()
                var prev_container = container_to_remove.prev()

            //removing current tab and container
                tab_to_remove.remove()
                container_to_remove.remove()

            // showing add button again and the possibility of scaling data
                totalNoForms--
                 $(totalSelector).val(totalNoForms);
                 if (totalNoForms < $(maxSelector).val()) {
                        addButton.show();
                    }
                 if (totalNoForms == 1) {
                        removeButton.hide();
                        addScalingData()
                    }

                // changing attributes of following items
                for (var i=0; i < all_next_tabs.length; i++){

                    var current_tab = $(all_next_tabs[i])
                    var current_container = $(all_next_containers[i])


                    var old_id = current_container.attr('id')

                    var new_num = parseInt(old_id.slice(-1)) - 1
                    var new_id = old_id.slice(0,-1) + new_num
                    var new_tab_id = new_id + '-tab'

                    // setting new values
                    current_tab.attr('id', new_tab_id)
                    current_tab.attr('href', '#' + new_id)
                    current_tab.attr('aria-controls', new_id)

                    current_container.attr('id', new_id)
                    current_container.attr('aria-labelledby', new_tab_id)

                    current_container.find(':input').each(function() {
                        var id = $(this).attr('id').replace(old_id, new_id);
                        var name = id.replace(/^id_/, '')
                        $(this).attr({'name': name, 'id': id});
                    });

                    current_container.find('label').each(function() {
                        var newFor = $(this).attr('for').replace(old_id, new_id);
                        $(this).attr('for', newFor);
                    });

                    current_container.find('.tabSpecific').each(function() {
                        var id = $(this).attr('id').replace(old_id, new_id);
                        $(this).attr('id', id);
                    });

                   $('#' + new_id + '-dataset').change()
                }

        // checking if there is a tab and a container after the ones removed and set them to be active;
        // if the last one is being removed, the previous ones are set to be the active
        // tabLinkClass and tabContentClass are sliced to remove the dot at the beginning

                if (next_tab.hasClass(tabLinkClass.slice(1, ))){
                    next_tab.toggleClass('active')
                    $(next_tab).after(removeButton)
                } else {
                    prev_tab.toggleClass('active')
        //            prev_tab.after(removeButton)
                }

                if (next_container.hasClass(tabContentClass.slice(1, ))){
                    next_container.toggleClass('active show')
                } else {
                    prev_container.toggleClass('active show')
                }
            }
        setTcLock();
        }

        $('#remove_dc_form').click(function() {
            removeTab('.dc_form', '.dc_form_link', 'datasets',  $('#add_dc_form'), $(this));
            start_ajax_to_set_valiadtion_period();
        });

        function set_after(first_element_selector, second_element_selector){
          $(first_element_selector).after($(second_element_selector))
        }

        function shiftTheButton(obj, buttonSelector){
            var currentObject = obj.currentTarget
            set_after(currentObject, buttonSelector)
          }

    </script>

    <!-- datepicker widget -->
    <link href ="/static/css/jquery-ui.css" rel = "stylesheet">
    <script src="/static/js/jquery-ui-1.12.1.js"></script>
    <script>
    function setTheDate(){
      // This is a function which set chosen date in the input field when
      // a change of a month or a year is done

      // need to know what casuses the change
      var event_target = event.target;
      var tagName = event_target.tagName;
      day = '01' // always set the first day, it's not that important
      var year = parseInt($('select.ui-datepicker-year').val());
      if(tagName=='SELECT'){
        // if it is a select just take a month number and add 1 because they start with 0
        var month = parseInt($('select.ui-datepicker-month').val()) + 1;
      } else if (tagName=='SPAN' || tagName=='A') {
        // if changes are done with arrows I am taking it from the field and
        // just add or subtract 1
        var month = parseInt($(this).val().slice(-5, -3));
        if(event_target.textContent=='Next'){
          month += 1
          // change of the year
          if(month>12){
            month = 1;
            year +=1;
          };
        } else if (event_target.textContent=='Prev') {
          month -= 1
          // change of the year
          if (month == 0){
            month = 12;
            year -= 1;
          };
        };
      };

      // add zero to look nice
      if(month<=9){month = '0' + month};
      // set the appropriate date
      $(this).val(year+'-'+month+'-'+day);
    }

    var today = new Date()
    var todays_year = today.getFullYear()
    var today_str = todays_year + '-' + (today.getMonth()+1) + '-' + today.getDate()

    var dates_settings = {
      dateFormat:'yy-mm-dd',
      changeMonth: true,
      changeYear: true,
      showButtonPanel: true,
      onChangeMonthYear: setTheDate,
      closeText: 'Apply',
      showMonthAfterYear: true,
      navigationAsDateFormat: true,
      showOn: "button",
      buttonText: "",
      minDate: '1978-01-01',
      maxDate: today_str,
      yearRange: '1978:'+todays_year
    }

     $(function() {
        $( "#id_interval_from" ).datepicker(dates_settings);
        $( "#id_interval_to" ).datepicker(dates_settings);
     });
    </script>

    <script type="text/javascript">

      function set_counter(){
        var counter = parseInt($('#click-counter').val())
        $('#click-counter').val(counter+1)
      }
      // this code is added so the tab closing button renders in an appropriate
      // place; it wasn't an issue before, because only one tab is rendered by default
      if($('#id_datasets-TOTAL_FORMS') >= $('#id_datasets-MIN_NUM_FORMS')){
        set_after('.dc_form_link.nav-item.nav-link.active', '#remove_dc_form')
      }

      if ('{{if_run_exists}}' == 'True' && '{{is_published}}' == 'True'){
        var url_to_go = $('#pub_validate-confirm').attr('data-url')
        $('#pub_validate-confirm').dialog({
          resizable: false,
          height: "auto",
          width: "auto",
          modal: true,
          buttons: {
            'Use the existing one': function() {
              window.location.href = url_to_go
            },
            "Run your own validation": function() {
              $('#validate-run').click(set_counter).click();
              $( this ).dialog( "close" );
            }
          }
        });
      }

      if ('{{if_run_exists}}' == 'True' && '{{is_published}}' == 'False'){
        var url_to_go = $('#non_pub_validate-confirm').attr('data-url')
        $('#non_pub_validate-confirm').dialog({
          resizable: false,
          height: "auto",
          width: "auto",
          modal: true,
          buttons: {
            'Use the existing one': function() {
              var validation_id = '{{ val_id }}';
              ajax_copy_validation(validation_id)

            },
            "Run your own validation": function() {
              $('#validate-run').click(set_counter).click();
              $( this ).dialog( "close" );
            }
          }
        });
      }

    </script>

    <script type="text/javascript">
        csrf_token = '{{csrf_token}}';
        result_list_url = "{% url 'myruns' %}";
        result_url = "{% url 'result' '00000000-0000-0000-0000-000000000000' %}";
        stop_validation_url = "{% url 'stop_validation' '00000000-0000-0000-0000-000000000000' %}";
    </script>
    <script src="{% static 'js/results_buttons.js' %}"></script>


{% endblock %}
