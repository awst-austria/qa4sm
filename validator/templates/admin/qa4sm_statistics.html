{% extends 'admin/base_site.html' %}
{% load static %}

{% block content %}
<script src="/static/js/plotly-latest.min.js"></script>
<script src="{% static 'js/jquery-3.4.1.min.js' %}"></script>
<link href="{% static 'css/service.css' %}" rel="stylesheet">


<center> <h1> <b>QA4SM statistics</b> </h1> </center>
<div>
    <h1> Currently we have <b>{{ stats.number_of_users }}</b> users </h1>
    <h1> Up to now <b>{{ stats.number_of_validations }}</b> {% if stats.number_of_validations == 1 %} validation has {% else %}
        validations have {% endif%} been run</h1>
    <h1> The user who runs validations most frequently is <b>{{stats.most_frequent_user.name}}</b> and he/she has run
        <b>{{stats.most_frequent_user.validation_num}}</b> by now</h1>

</div>
<div>
    <h1>To see statistics on a particular user please choose the user from the list:
        <select id="users_list">
        {%for user in stats.users%}
            <option id='user_{{user.pk}}' value='{{user.id}}'> {{user.username}} </option>
        {%endfor%}
        </select>
    </h1>
</div>
<div id='user_info' hidden>
  <h1>Information on user <span id='username'></span>:</h1>
  Last login: <span id='last_login'></span> <br>
  Number of validations: <span id='validation_number'></span> <br>
  Last validation: <span id='last_validation'></span> <br>
  Used datasets: <br>

  <button id='hide_user_info' value='Hide'> Hide </button>
</div>
<div id="val_nums_by_users" class="plot_div"></div>
<div id="validations_in_time" class="plot_div"></div>
<div id="datasets_cumulative" class="plot_div"></div>
<script type="text/javascript">
  // hiding ifo on a user
  $('#hide_user_info').on('click', function(){
    $('#user_info')[0].hidden = true;
  })
 // showing info on a user
  function show_info(info){
    $('#user_info')[0].hidden = false;
    $('#username').text(info.username)
    $('#validation_number').text(info.validations_num)
    $('#last_validation').text(info.last_validation)
    $('#last_login').text(info.last_login)
  }


  // ajax to take info on a user
  function ajax_show_user_info(user_id) {
      var url = '/admin/validator/statistics/user_id';
      var user_id = $('#users_list').val()
      $.ajax({
          url: url,
          data: {'user_id': user_id},
          success: function (return_data) {
              // var user_name = return_data['user_name'];
              var info = {
                'username': return_data['user_name'],
                'validations_num': return_data['val_num'],
                'last_validation': return_data['last_validation'],
                'last_login': return_data['last_login']
              }
              show_info(info)
              console.log(info.username, info.validations_num)
        }
      });
  }

$("#users_list").change(ajax_show_user_info).change()

</script>


<script>
// Common plot parameters:
  // ============ Font size =================
  var title_font_size = 20;
  var axis_font_size = 16;
  var tick_font_size = 12;
  // ============ Font type =================
  var title_font_type = 'Arial, monospace';
  var axis_font_type = 'Arial, monospace';
  var tick_font_type = 'Arial, monospace';
  // ============ Colors =================
  var plot_bgcolor = 'rgb(240, 240, 240)';
  var basic_color = 'rgb(0, 204, 204)'//'rgb(255,20,147)';
  var versions_colors = ['rgb(0, 204, 204)', 'rgb(0, 204, 0)', 'rgb(204, 0, 0)', 'rgb(204, 0, 204)']

  //==========================================================================================
    // Datasets counts
    var datasets_info = {{ stats.datasets_for_plot|safe }}
    var datasets = datasets_info.datasets
    var versions = datasets_info.versions
    var dataset_counts = datasets_info.dataset_count

    var datasets_plot_data = []
    for (var dataset_ind=0; dataset_ind<datasets.length; dataset_ind++){
      for (var vers_ind=0; vers_ind<versions[dataset_ind].length; vers_ind++){
        var data = {
          x: [datasets[dataset_ind]],
          y: [dataset_counts[dataset_ind][vers_ind]],
          name: versions[dataset_ind][vers_ind],
          type: 'bar',
          // marker: {
          //   color: versions_colors[vers_ind]
          // }
        }
        datasets_plot_data.push(data)
      }
    }

    var datasets_plot_layout = {
      barmode: 'stack',
      plot_bgcolor: plot_bgcolor,
      title: {
        text:'Datasets counts',
        font: {
          family: title_font_type,
          size: title_font_size,
        },
      yref: 'container',
      y: 0.85
        },
      xaxis: {
        title: {
            text:'Datasets',
            font: {
              family: axis_font_type,
              size: axis_font_size},
              standoff: 10,
            },
        tickfont:{
          size: tick_font_size,
          family: tick_font_type
        },
        automargin: true
      },
      yaxis: {
        title: {
            text:'Counts',
            font: {
              family: axis_font_type,
              size: axis_font_size}
            }
        }
    }

  Plotly.react(datasets_cumulative, datasets_plot_data,  datasets_plot_layout);
  //==========================================================================================
    // Number of validations run by each user plot
	var val_nums_by_users_div = $('#val_nums_by_users')[0];
  var val_nums_by_users_plot_data = [{
        x: {{stats.val_num_by_user_data.users|safe}},
        y: {{stats.val_num_by_user_data.validations_num|safe}},
        type: 'bar',
        marker: {
          color: basic_color
        }
    }]

  var val_nums_by_user_layout = {
    plot_bgcolor: plot_bgcolor,
    title: {
      text:'Number of validations run by each user',
      font: {
        family: title_font_type,
        size: title_font_size
      },
    yref: 'container',
    y: 0.85
      },
    xaxis: {
      title: {
          text:'Users',
          font: {
            family: axis_font_type,
            size: axis_font_size},
            standoff: 10,
          },
      tickfont:{
        size: tick_font_size,
        family: tick_font_type
      },
      automargin: true
    },
    yaxis: {
      title: {
          text:'Number of validations',
          font: {
            family: axis_font_type,
            size: axis_font_size}
          }
      }
  }

	Plotly.react( val_nums_by_users_div, val_nums_by_users_plot_data, val_nums_by_user_layout);

//==========================================================================================
  // Number of validations by time range:
  var first_epoch = {{stats.validations_for_plot.first_validation|safe}}[0];
  var last_epoch = {{stats.validations_for_plot.last_validation|safe}}[0];
  var H1 = 3600000; //xbins are defined in mili seconds, therefore one hour is defined this way
  var D1 = H1 * 24; // one day
  var W1 = D1 * 7; // one week
  var val_nums_by_users_div = $('#validations_in_time')[0];

  var validations_in_time_data = [{
        x: {{ stats.validations_for_plot.validations_time|safe }},
        autobinx: false,
        autobiny: true,
        marker: {color: basic_color},
        name: 'date',
        type: 'histogram',
        xbins: {
          end: last_epoch,
          size: H1,
          start: first_epoch
        }
    }];

  var validations_in_time_layout = {
      plot_bgcolor: plot_bgcolor,
      title: {
        text: 'Number of validations in particular time periods',
        font: {
          family: title_font_type,
          size: title_font_size},
      yref: 'container',
      y: 0.85
        },
      xaxis: {
        type: 'date',
        autorange: false,
        range: [first_epoch, last_epoch],
        title: {
          text:'Date range',
          font: {
            family: axis_font_type,
            size: axis_font_size}
          },
        font: {
          family: axis_font_type,
          size: axis_font_size}
      },
      yaxis: {
        autorange: true,
        title: {
          text:'Number of validations',
          font: {
            family: axis_font_type,
            size: axis_font_size}},
        type: 'linear'
      },
      updatemenus: [{
            x: 0.1,
            y: 1.15,
            xref: 'paper',
            yref: 'paper',
            yanchor: 'top',
            active: 0,
            showactive: true,
            buttons: [{
                args: ['xbins.size', H1],
                label: 'Hour',
                method: 'restyle',
            },{
                args: ['xbins.size', D1],
                label: 'Day',
                method: 'restyle',
            }, {
                args: ['xbins.size', W1],
                label: 'Week',
                method: 'restyle',
            }, {
                args: ['xbins.size', 'M1'],
                label: 'Month',
                method: 'restyle',
            }, {
                args: ['xbins.size', 'M3'],
                label: 'Quater',
                method: 'restyle',
            }, {
                args: ['xbins.size', 'M6'],
                label: 'Half Year',
                method: 'restyle',
            }, {
                args: ['xbins.size', 'M12'],
                label: 'Year',
                method: 'restyle',
            }]
      }]
};

Plotly.newPlot(validations_in_time, validations_in_time_data, validations_in_time_layout);


</script>


{% endblock %}
