<div class="grid no-gutters" [ngClass]="{'non-scrollable': isExistingValidationWindowOpen}">
  <div *ngIf="(authService.authenticated|async)===false"
       class="col-12 alert center">
    <h5 class="pt-2">
      You are not logged in.
      You can check validation options, but cannot start a validation.
      <a [routerLink]="'/login'" class="mt-5">Click here</a> or on the Validate button
      to log in or use
      <a [routerLink]="'/signup'" class="mt-5">this form</a>
      to register.
    </h5>

  </div>
  <div class="
    col-12
    md:col-10 md:col-offset-1
    lg:col-10 lg:col-offset-1
    xl:col-8 xl:col-offset-2">

    <div *ngIf="!maintenanceMode" class="grid" style="justify-content: center">

      <!--  data column-->
      <div class="md:col-5 col-10">
<!--        here toggleable is set to false, otherwise accordions won't close, that's a bug in primeng 15.4.1-->
        <p-panel header="Data" [toggleable]="false" class="validation-small-row">
          <ng-template pTemplate="icons">
            <label class="p-panel-header-icon"
                   pTooltip="The soil moisture dataset which is to be validated, i.e. compared to the 'Reference' data."
                   tooltipPosition="bottom">
              <span class="pi pi-question-circle"></span>
            </label>
          </ng-template>
          <p-accordion multiple="true">

            <p-accordionTab *ngFor="let item of validationModel.datasetConfigurations; index as datasetIdx"
                            [header]="(item.datasetModel.selectedDataset?.pretty_name)+' / ' +
                             ''+(item.datasetModel.selectedVersion?.pretty_name)+' / '+(item.datasetModel.selectedVariable?.short_name)
                             + (validationConfigService.getInformationOnTheReference((item.spatialReference$|async), (item.temporalReference$|async), (item.scalingReference$|async)))"
                            [selected]="datasetIdx === validationModel.datasetConfigurations.length - 1"
                            [class]="{'highlighted': (item.highlighted$|async),
                            'is-reference': ((item.spatialReference$|async) || (item.temporalReference$|async) || (item.scalingReference$|async))}">

              <qa-dataset *ngIf="validationModel.datasetConfigurations[datasetIdx].datasetModel.selectedDataset"
                          [selectionModel]="validationModel.datasetConfigurations[datasetIdx].datasetModel"
                          [removable]="true" (changeDataset)="onDatasetChange($event)"></qa-dataset>

              <ng-container *ngFor="let filter of item.basicFilters; let filterIdx = index">
                <qa-basic-filter
                  [ngClass]="{'ml-1-icon': isIncluded(filter.filterDto.id, item.basicFilters)}"
                  [isIncluded]="isIncluded(filter.filterDto.id, item.basicFilters)"
                  [filterModel]="filter"
                  (excludeMutual)="this.includeFilter($event, item.basicFilters, false)"
                  (includeMutual)="this.includeFilter($event, item.basicFilters, filter.enabled)">
                </qa-basic-filter>
              </ng-container>

              <qa-threshold-filter *ngIf="validationModel.datasetConfigurations[datasetIdx].smosRfiFilter$|async"
                                   [datasetModel]="validationModel.datasetConfigurations[datasetIdx].datasetModel"
                                   [filterModel$]="validationModel.datasetConfigurations[datasetIdx].smosRfiFilter$"
                                   [minThreshold]="0." [increment]="0.05" maxThreshold="1." [units]="' [-]'">
              </qa-threshold-filter>

              <qa-threshold-filter *ngIf="validationModel.datasetConfigurations[datasetIdx].smosChi2Filter$|async"
                                   [datasetModel]="validationModel.datasetConfigurations[datasetIdx].datasetModel"
                                   [filterModel$]="validationModel.datasetConfigurations[datasetIdx].smosChi2Filter$"
                                   [minThreshold]="0." [increment]="0.05" maxThreshold="1." [units]="' [-]'">
              </qa-threshold-filter>
              <div *ngIf="validationModel.datasetConfigurations[datasetIdx].ismnNetworkFilter$|async">
                <qa-ismn-network-filter

                  [datasetModel]="validationModel.datasetConfigurations[datasetIdx].datasetModel"
                  [filterModel$]="validationModel.datasetConfigurations[datasetIdx].ismnNetworkFilter$"></qa-ismn-network-filter>
              </div>
              <div *ngIf="validationModel.datasetConfigurations[datasetIdx].ismnDepthFilter$|async">
                <qa-ismn-depth-filter
                  [datasetModel]="validationModel.datasetConfigurations[datasetIdx].datasetModel"
                  [filterModel$]="validationModel.datasetConfigurations[datasetIdx].ismnDepthFilter$">
                </qa-ismn-depth-filter>
              </div>

              <div style="width: 100%;text-align: right">
                <button pButton type="button"
                        [disabled]="validationModel.datasetConfigurations.length < 3"
                        (click)="removeDataset(validationModel.datasetConfigurations[datasetIdx])"
                        label="Remove dataset"
                        icon="pi pi-trash"
                        class="removeDataset p-button-danger my-2"
                        style="padding: 0.2rem;">
                </button>
              </div>
            </p-accordionTab>

          </p-accordion>
          <button pButton
                  type="button"
                  label="Add dataset"
                  icon="pi pi-plus-circle"
                  (click)="addDatasetToValidate()"
                  class="addDataset p-button-success my-2"
                  style="padding: 0.2rem;"
                  [disabled]="addDatasetButtonDisabled()">
          </button>

        </p-panel>
      </div>


      <div class="md:col-5 col-10">
        <!--  reference column-->
        <p-panel header="Reference" [toggleable]="true" class="validation-small-row">
          <ng-template pTemplate="icons">
            <label class="p-panel-header-icon"
                   pTooltip="Select which dataset chosen in the 'Data' component should be marked as spatial and temporal reference."
                   tooltipPosition="bottom">
              <span class="pi pi-question-circle"></span>
            </label>
          </ng-template>

          <!--             spatial reference-->
          <div class="pt-2">
            <label for="spatial-reference"
                   class="mb-4"
                   pTooltip="Choose the spatial reference dataset. If the ISMN dataset belongs to the dataset pool, it has to be chosen as the spatial reference."
                   tooltipPosition="bottom">
              <span class="pi pi-question-circle"></span>
              Spatial reference
            </label>
            <qa-validation-reference
              id="spatial-reference"
              #spatialReference
              [validationModel]="validationModel"
              [referenceType]="'spatialReference$'"
              (hoverOverDataset)="onHoverOverReferenceDataset($event)"></qa-validation-reference>
          </div>

          <!--             temporal reference-->
          <div>
            <label for="temporal-reference"
                   class="mb-4"
                   pTooltip="Choose the temporal reference dataset. Please note, that we do not recommend selecting ISMN."
                   tooltipPosition="bottom">
              <span class="pi pi-question-circle"></span>
              Temporal reference
            </label>
            <qa-validation-reference
              id="temporal-reference"
              #temporalReference
              [validationModel]="validationModel"
              [referenceType]="'temporalReference$'"
              (hoverOverDataset)="onHoverOverReferenceDataset($event)"></qa-validation-reference>
          </div>


        </p-panel>


        <!--      Scaling-->
        <!--        <p-panel header="Reference" [toggleable]="true" class="validation-small-row">-->
        <!--          <div class="col-10">-->
        <qa-scaling
          [validationModel]="validationModel"
          (hoverOverDataset)="onHoverOverReferenceDataset($event)"
        ></qa-scaling>
        <!--          </div>-->
        <!--        </p-panel>-->


      </div>

      <!--      Map-->
      <div class="col-10">
        <p-panel toggleable="true" [header]="'Map'" styleClass="map-panel" class="validation-row">
          <qa-map class="map" #qwerty
                  [spatialSubset]="validationModel.spatialSubsetModel"
                  [center]="[10, 52.5]"
                  [zoom]="2.5"></qa-map>
        </p-panel>

      </div>

      <!--      Spatial subsetting-->
      <div class="col-10">
        <qa-spatial-subset [subsetModel]="validationModel.spatialSubsetModel"></qa-spatial-subset>
      </div>


      <p-panel header="Temporal Subsetting" [toggleable]="true" class="validation-row col-10">
        <ng-template pTemplate="icons">
          <label class="p-panel-header-icon"
                 pTooltip="Select validation period and temporal matching window."
                 tooltipPosition="bottom">
            <span class="pi pi-question-circle"></span>
          </label>
        </ng-template>

        <!--      Validation period-->
        <div>
          <qa-validation-period [validationPeriodModel]="validationModel.validationPeriodModel"></qa-validation-period>
        </div>
        <!--      Temporal matching-->
        <div>
          <qa-temporal-matching [temporalMatchingModel]="validationModel.temporalMatchingModel"></qa-temporal-matching>
        </div>

      </p-panel>


      <!--      Metrics-->
      <div class="col-10">
        <qa-metrics [validationModel]="validationModel"></qa-metrics>
      </div>


      <!--      Anomalies-->
      <div class="col-10">
        <qa-anomalies [anomaliesModel]="validationModel.anomalies"></qa-anomalies>
      </div>

      <!--      &lt;!&ndash;      Scaling&ndash;&gt;-->
      <!--      <div class="col-10">-->
      <!--        <qa-scaling [validationModel]="validationModel"></qa-scaling>-->
      <!--      </div>-->

      <!-- Name -->
      <div class="col-10">
        <div class="grid px-2">
            <span class="label col-1">
              <label for="name">Name your validation</label>
            </span>
          <input class="form-field col"
                 id="name"
                 type="text"
                 pInputText
                 [ngModel]="validationModel.nameTag$|async"
                 (ngModelChange)="validationModel.nameTag$.next($event)">
          <span
            pTooltip="You can optionally name the validation to make it easier to identify in your list of validations."
            class="pi pi-question-circle col-1 help-field">
          </span>
        </div>
      </div>

      <div class="col-10">
        <div>
          <div class="d-flex justify-content-center">
            <span
              pTooltip="{{disableValidateButton(validationModel) ? 'You can not start a validation, because one of the chosen dataset has no variable assigned.' : ''}}">
              <p-button
                id="validateButton"
                label="Validate"
                icon="pi pi-play"
                [disabled]="disableValidateButton(validationModel)"
                (onClick)="startValidation(true)">
              </p-button>
            </span>
          </div>
        </div>
      </div>

    </div>

    <div *ngIf="maintenanceMode" class="container text-center mb-5 mt-4" style="max-width: 40rem;">
      <h1 class="jumbotron-heading">Maintenance...</h1>
      <p class="lead text-muted">Sorry! Currently, you can't start new validations because we're doing maintenance on
        the service. Please come back later.</p>
    </div>

  </div>
  <qa-existing-validation *ngIf="isExistingValidationWindowOpen"
                          [isThereValidation]="isThereValidation"
                          (startValidation)="startValidation(false)">
  </qa-existing-validation>
  <p-dialog header="You need to be logged in to start a validation" id="log-in" [modal]="true"
            [(visible)]="logInToValidate">
    <div>
      <app-login (loggedIn)="setLoggedIn()"></app-login>
    </div>

  </p-dialog>
</div>
<p-scrollTop styleClass="scroll-button"></p-scrollTop>
