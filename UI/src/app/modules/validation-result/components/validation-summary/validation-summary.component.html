<main class="p-grid p-mx-0">
  <p-panel class="p-col-12">
    <ng-template pTemplate="header">
      <div class="text-center" style="width:100%">
        <h4 class="p-my-0 font-weight-normal">
          Summary:
          <span *ngIf="validationRun.is_unpublished && isOwner">
          <span *ngIf="hideElement" class="my-0 font-weight-normal no_edit_name">{{valName$|async}} </span>
          <button
            pButton
            type="button"
            [ngClass]="{'btn-action edit_name_btn': true, 'hidden': !hideElement}"
            title="Change Name"
            icon="faIcons.faPencil"
            (click)="toggleEditing()">
            <fa-icon [icon]="faIcons.faPencil"></fa-icon>
          </button>
          <span *ngIf="!hideElement">
            <label for="new-name"></label>
            <input id="new-name"
                   type="text"
                   value="{{valName$|async}}"
                   #newName
                   [ngClass]="{'edit_name': true}">
            <button
              pButton
              type="button"
              [ngClass]="{'btn-action save_name_btn result_page': true}"
              title="Save Name"
              icon="pi pi-save"
              (click)="saveName(validationRun.id, newName.value)">
            </button>
            <button
              pButton
              type="button"
              [ngClass]="{'btn-action cancel_editing_btn result_page': true}"
              title="Cancel"
              icon="pi pi-ban"
              (click)="toggleEditing()">
            </button>
          </span>
        </span>
          <span *ngIf="!validationRun.is_unpublished"
                class="p-my-0 font-weight-normal no_edit_name">{{valName$|async}}
            <span class="no_name_change_info pi pi-question-circle help-icon"
                  title="Validation has been published. There is no possibility of changing its name."> </span>
            </span>
          <span *ngIf="!isOwner"
                class="p-my-0 font-weight-normal no_edit_name">{{valName$|async}}
            <span class="no_name_change_info pi pi-question-circle help-icon"
                  title="Validation belongs to another user. There is no possibility of changing its name."> </span>
            </span>
        </h4>
      </div>
    </ng-template>
    <div *ngIf="configurations$| async as configurations" class="card-body">
      <ul>
        <li *ngIf="validationRun.is_a_copy">
          Validation copied on {{ validationRun.start_time | date: dateFormat :timeZone }} {{timeZone}},
          original validation run on {{this.originalDate| date: 'mediumDate' :timeZone }}.
        </li>
        <li *ngIf="!validationRun.is_a_copy">Started validation on {{ validationRun.start_time | date: dateFormat :timeZone }} {{timeZone}}, finished
          on {{ validationRun.end_time | date: dateFormat :timeZone }} {{timeZone}}.
        </li>
        <li>Compared {{ configurations.length  }} datasets:
          <ul>
            <li *ngFor="let config of configurations; let ind = index">
              <em *ngIf="config.id != validationRun.reference_configuration">Dataset {{ind + 1}}:</em>
              <em *ngIf="config.id == validationRun.reference_configuration">Reference:</em>

              {{config.dataset}} ({{config.version}}, {{config.variable}})
              [Filters:
              <span *ngFor="let filter of config.filters"> {{filter}}; </span>
              <span *ngFor="let paramFilter of config.parametrisedFilters; let indF = index">
                              {{paramFilter}} {{config.parametrisedFiltersValues[indF]}}
              </span>]
            </li>
          </ul>
        <li
          *ngIf="validationRun.min_lat && validationRun.min_lon && validationRun.max_lat && validationRun.max_lon; else elseSpatial">
          Spatial filter bounding box: [{{ validationRun.min_lat }}, {{ validationRun.min_lon }}
          , {{ validationRun.max_lat }}, {{ validationRun.max_lon }}].
        </li>
        <ng-template #elseSpatial>
          <li>
            Validated globally.
          </li>
        </ng-template>


        <li *ngIf="validationRun.interval_from && validationRun.interval_to; else elseTemporal">Validation period /
          temporal
          filter: {{ validationRun.interval_from | date: dateFormat :timeZone }} {{timeZone}}
          to {{ validationRun.interval_to | date: dateFormat :timeZone }} {{timeZone}}.
        </li>
        <ng-template #elseTemporal>
          <li>Validated over entire available timespan.</li>
        </ng-template>


        <li *ngIf="validationRun.anomalies != 'none'; else elseAnomalies">
          Validation metrics calculated from anomalies
          <span *ngIf="validationRun.anomalies == 'climatology'">
                against climatology computed on years {{ validationRun.anomalies_from|date:"Y" }}
            through {{ validationRun.anomalies_to|date:"Y" }}.
              </span>
          <span *ngIf="validationRun.anomalies == 'moving_avg_35_d'">
              against 35 day moving average.
              </span>
        </li>
        <ng-template #elseAnomalies>
          <li>Validation metrics calculated from absolute values.</li>
        </ng-template>


        <li>Triple collocation analysis was
          <span *ngIf="validationRun.tcol">activated. </span>
          <span *ngIf="!validationRun.tcol">deactivated. </span>
        </li>

        <li>Bootstrapping of confidence intervals for Triple Collocation Analysis was
          <span *ngIf="validationRun.bootstrap_tcol_cis">activated. </span>
          <span *ngIf="!validationRun.bootstrap_tcol_cis">deactivated. </span>
        </li>

        <li *ngIf="validationRun.scaling_method != 'none'; else elseScaling">Scaling reference:
          <span *ngFor="let config of configurations">
                <span *ngIf="config.id === validationRun.reference_configuration">
                  {{config.dataset}} ({{ config.version }}, {{ config.variable }})

                  <span *ngIf="config.filters || config.parameterisedFilters; else elseFilters">[Filters:
                  <span *ngFor="let filter of config.filters"> {{filter}}; </span>
                  <span *ngFor="let paramFilter of config.parametrisedFilters; let indF = index">
                              {{paramFilter}} {{config.parametrisedFiltersValues[indF]}}
                            </span>
                    ]</span>
                  <ng-template #elseFilters>
                    none
                  </ng-template>
              </span>
              </span>
        </li>

        <ng-template #elseScaling>
          <li> Scaling reference: {{ scalingMethods[validationRun.scaling_method] }}.</li>
        </ng-template>
        <li> Scaling method: {{ scalingMethods[validationRun.scaling_method] }}.</li>


        <li>Processing took {{ runTime }} minutes (wall time).</li>


        <li *ngIf="validationRun.progress === -1; else elseProgress">The validation was cancelled.</li>
        <ng-template #elseProgress>
          <li [ngClass]="{'alert-danger': errorRate > 0}">
            {{errorRate * 100 | number: '.0'}}% ({{ validationRun.error_points }}
            of {{ validationRun.total_points }}) of the processed locations (grid points) produced errors during
            calculation.
          </li>
        </ng-template>
        <li *ngIf="!(isArchived$|async) && getCurrentUser() === validationRun.user">
          <span *ngIf="isNearExpiry$|async">
            <span class="p-panel-header-icon pi pi-exclamation-triangle expiry-icons"></span>
            This validation will SOON be automatically removed during cleanup
            on {{ (expiryDate$|async)|date: dateFormat :timeZone}} {{timeZone}}.
          </span>

          <span *ngIf="!(isNearExpiry$|async)">
            <span class="p-panel-header-icon pi pi-calendar expiry-icons"></span>
            This validation will be automatically removed during cleanup
            on {{ (expiryDate$|async)|date: dateFormat :timeZone }} {{timeZone}}.
          </span>

        </li>
        <li *ngIf="(isArchived$|async) && validationRun.is_unpublished">
              <span
                class="p-panel-header-icon pi expiry-icons">
                <fa-icon [icon]="faIcons.faArchive"></fa-icon>
              </span>
          This validation has been archived. It will NOT be automatically removed during cleanup.

        </li>
        <li *ngIf="!validationRun.is_unpublished">
          <span class="pi pi-book"></span> This result was published on zenodo with DOI
          <a target="_blank" href="{{getDoiPrefix()}}{{validationRun.doi }}">{{ validationRun.doi }}</a>.
        </li>
      </ul>
      <qa-buttons *ngIf="validationModel.validationRun|async as validation" [validationList]="false" [validationRun]="validation" (doUpdate)="update($event)"></qa-buttons>
    </div>
  </p-panel>
</main>
